
<!DOCTYPE html>
<html>
    <meta name="viewport" content="width=device-width" name="theme-color" content="#4285f4">
    <link rel="shortcut icon" href="https://www.transparentpng.com/thumb/saturn/3d-saturn-free-png-IK0bAI.png"
    type="image/x-icon" />


<body>
<style>
#img{
	border-style:solid;
width:400px;
height:300px;
display:none;

}
#canvas{
    border-style:solid;
    background:url(https://thumbs.dreamstime.com/b/sunset-beach-sunrays-133301221.jpg);
    background-size: 100% 102%;
}
#tx{
    border-style:solid;
    width:50%;
height:400px;
}
#entradas{
    position:absolute;
    right:0px;
    bottom:0px;
    width:50%;
    height:50%;
    background:rgba(200,240,255,.4);
    padding:5px;
        
}
#texto{
    width:100%;
    height:50%;
    background:rgba(230,255,200,.5);

}

</style>
<div id="entradas">
<input type="file" oninput="openf(this)"></input>
<textarea id="texto"></textarea>
bk<input type="text" oninput="rule.bk=this.value"/>
clv:<input type="text" value="40.8.3" oninput="setrule(this.value)"/>

<button onclick="procesar()">Procesar</button><br><button onclick="savepic()">Save</button>
<p id="clv"></p>


</div>
	<img id="img"src-"https://media4.s-nbcnews.com/j/msnbc/Components/Photos/050405/050405_shuttle_vmed.fit-760w.jpg">
	<canvas id="canvas" width=400 height=300></canvas>
    <button onclick="init()">get date</button>
    <textarea id="tx"></textarea>


<script>
  pic="https://thumbs.dreamstime.com/b/sun-rays-mountain-landscape-5721010.jpg"
rule={offset:40,skeep:8,place:3,bk:"100% 101%"};
var data,fdata;
canvas.style.backgroundSize=rule.bk
img.onload=function(){
    
ctx.drawImage(img,0,0,400,300)
fdata=ctx.getImageData(0,0,400,300);
data=fdata.data;
tx.value=data;
}
var ctx=canvas.getContext("2d");


toDataURL(pic, function(dataUrl) {
 // https://www.gravatar.com/avatar/d50c83cc0c6523b4d3f6085295c953e0
  img.src=dataUrl;
})

   function setrule(r){
       try{
        
           var a=r.split(".");
         rule.offset=a[0]*1;rule.skeep=a[1]*1;rule.place=a[2]*1
         clv.innerHTML=JSON.stringify(rule)
       }
       catch(e){}
     }



function procesar(){
  ctx.drawImage(img,0,0,400,300)
  canvas.style.backgroundSize=rule.bk
  fdata=ctx.getImageData(0,0,400,300);
data=fdata.data;//alert(data.length)
var n=texto.value;
for(var i=0;i<n.length;i++){
 // alert(rule.offset*1+i*rule.skeep*1+rule.place*1)
    data[rule.offset*1+i*rule.skeep*1+rule.place*1]=n.charCodeAt(i);
}
fdata.data=data;
tx.value=data;
ctx.putImageData(fdata,0,0)
}

function init(){
    tx.value=data;

}

function toDataURL(url, callback) {
  var xhr = new XMLHttpRequest();
  xhr.onload = function() {
    var reader = new FileReader();
    reader.onloadend = function() {
      callback(reader.result);
    }
    reader.readAsDataURL(xhr.response);
  };
  xhr.open('GET', url);
  xhr.responseType = 'blob';
  xhr.send();
}

function savepic() {
  canvas.toBlob(function(blob) {

             var url = URL.createObjectURL(blob);
             var fileName = 'ScreenShot-' + document.title + '-' + Date.now(); //png';
             var anchor = document.createElement('a');
             anchor.href = url;
             anchor.setAttribute("download", fileName);
             anchor.className = "download-js-link";
             anchor.innerHTML = "downloading...";
             anchor.style.display = "none";
             document.body.appendChild(anchor);
             setTimeout(function() {
                 anchor.click();
                 document.body.removeChild(anchor);
             }, 1);

         }, 'image/png');

     }


     function openf(v) {
              var t=prompt("1 a text or 2 as Image")
            var fr=new FileReader();
            fr.onload=function(){
            if(t==null || t==1) texto.value=fr.result;
            else {
              img.src=fr.result;

            }
            }
              
            if(t==null || t==1) fr.readAsText(v.files[0]);
           else fr.readAsDataURL(v.files[0]);

        }
  

</script>


  </body>
</html>

